<!DOCTYPE html>

<html>
<head>
	<link rel="stylesheet" type="text/css" href="modules/conditions/d1/spd1/d1Spd1.css">
</head>
<body>


	<div id = 'cat1spd1'>
		<div id = "test-buttons">
			<button type ="button" name ="researchButton" id = "button1">Anomaly in graph 1</button>
		</div>
	</div>

	<script>
	var socket = io.connect();
	(function(){

		experimentr.startTimer('websocketTest')

		//record all mouse movement 
		document.onmousemove = experimentr.sendMouseMovement;

	})();

	d3.select('body').selectAll('button').on('click',function(){
		pressed(d3.select(this).attr('id') , "button");
		console.log('button pressed');
		if (d3.select(this).attr('name') !== 'researchButton'){
				//stops  recording and transmitting mouse events
				document.onmousemove = experimentr.stopMouseMovementRec;
				socket.emit('disconnect');
				experimentr.next();
			};
		});


	window.addEventListener("keydown", checkKeyPressed, false);


	function checkKeyPressed(e) {
		if (e.keyCode == "13" || e.keyCode == "32") {
			pressed(e.keyCode, "key");
			console.log('key pressed')
		}
	}


	function pressed(buttonTitle, type){
		var isPresent = checkForAnamoly();
		console.log('is anomolyPresent' + isPresent); 

		var timePressed = experimentr.now('websocketTest');
		timestamp = new Date().getTime();
		console.log('mouse pressed. Socket emit ')
		postId = 1234
		socket.emit('mouseClick',{interactionType: type, buttonTitle: buttonTitle, timePressed: timePressed, postId: postId, timestamp:timestamp});
	};




	var n = 30;
	var margin = {top:20, right:20, bottom:20, left:20},
	width = 600 - margin.left - margin.right,
	height = 500 - margin.top - margin.bottom;
	var duration = 200000;




	var x = d3.scale.linear()
	.domain([0,n-1])
	.range([0,width]);
	var y = d3.scale.linear()
	.domain([-0.5, 0.5])
	.range([height/3, 0]);

	var y2 = d3.scale.linear()
	.domain([-0.5, 0.5])
	.range([height*2/3, height/3]);

	var y3 = d3.scale.linear()
	.domain([-0.5, 0.5])
	.range([height, height*2/3]);
//The moving line part   



var svgContainer = d3.select("body").append("svg")
.attr("width", 1500)
.attr("height", 1000);



var xAxis=d3.svg.axis().scale(x).orient("bottom");

var svg	= svgContainer.append("g")
.attr("transform", "translate(" +40+ "," + 20 + ")");
svg.append("g")
.attr("class","x axis")
.attr("transform","translate(0," + y(0)+")")
.call(xAxis);

svg.append("defs").append("clipPath")
.attr("id","clip")
.append("rect")
.attr("width",width)
.attr("height",height+500);

svg.append("defs").append("clipPath")
.attr("id","clip2")
.append("rect")
.attr("transform","translate(0,0)")
.attr("width",width)
.attr("height",height+500);

svg.append("g")
.attr("class", "x axis")
.attr("transform", "translate(0," + y2(0) + ")")
.call(xAxis);

svg.append("g")
.attr("class", "x axis")
.attr("transform", "translate(0," + y3(0) + ")")
.call(xAxis);

d3.tsv("data/caseTest1.tsv", type, function(error,data){
	
	var line  = d3.svg.line()
	.x(function(d,i){return x(d.index);})
	.y(function(d,i){return y(d.value);})
	.interpolate("basis");

	var path =svg.append("g")
	.attr("clip-path","url(#clip)")
		//.attr("id","path")
		.append("path")
		.datum(data)
		.attr("class","line1")
		.attr("d",line)
		.transition()
		.duration(duration)
		.ease("linear")
		.attr("transform","translate("+x(-1999) + ",0)")
		.each("end", validate);


	})

d3.tsv("data/caseTest2.tsv", type, function(error,data){

	var line = d3.svg.line()
	.x(function(d,i){return x(d.index);})
	.y(function(d,i){return y2(d.value);})
	.interpolate("basis");


	var path = svg.append("g")
	.attr("clip-path","url(#clip)")
		//.attr("id","path")
		.append("path")
		.datum(data)
		.attr("class","line2")
		.attr("d",line)
		.transition()
		.duration(duration)
		.ease("linear")
		.attr("transform","translate("+x(-1999) + ",0)")
		.each("end", validate);
		//.attr("stroke",st)
		

	})

d3.tsv("data/caseTest3.tsv", type, function(error,data){

	var line = d3.svg.line()
	.x(function(d,i){return x(d.index);})
	.y(function(d,i){return y3(d.value);})
	.interpolate("basis");


	var path = svg.append("g")
	.attr("clip-path","url(#clip)")
		//.attr("id","path")
		.append("path")
		.datum(data)
		.attr("class","line3")
		.attr("d",line)
		.transition()
		.duration(duration)
		.ease("linear")
		.attr("transform","translate("+x(-2000) + ",0)")
		.each("end", validate);;

	})

function checkForAnamoly(){
	var currentIndex1 = Math.ceil((d3.transform(d3.select('.line1').attr("transform")).translate[0])*-1)
	var currentIndex2 = Math.ceil((d3.transform(d3.select('.line2').attr("transform")).translate[0])*-1)
	var currentIndex3 = Math.ceil((d3.transform(d3.select('.line3').attr("transform")).translate[0])*-1)

	var anomolyPresent = false;

	var data1 = d3.select(".line1").datum();
	var data2 = d3.select(".line2").datum();
	var data3 = d3.select(".line3").datum();

	for (var i = currentIndex1; i < currentIndex1-width; i++){
		console.log('noise test', i, " indexed   ", data1[i]); 
		if(data1[i].noise == "T"){
			anomolyPresent = true;
			console.log('anomoly is present');
			return anomolyPresent
		}
	}

	for (var i = currentIndex2; i < currentIndex2+width; i++){
		if(data2[i].noise == "T"){
			anomolyPresent = true;
			console.log('anomoly is present');
			return anomolyPresent
		}
	}

	for (var i = currentIndex3; i < currentIndex3+width; i++){
		if(data3[i].noise == "T"){
			anomolyPresent = true;
			console.log('anomoly is present');
			return anomolyPresent
		}
	}

	return anomolyPresent;
}

function type(d){
	d.index = +d.index;
	d.value = +d.value;
	return d;
}

function validate() {
	experimentr.endTimer('demo');
	experimentr.release();
}

</script>


</body>
</html>